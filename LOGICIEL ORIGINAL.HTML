<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solaire Pro BF - Expert V4.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; margin: 0; }
        
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .splash-logo {
            color: #fbbf24;
            font-size: 4rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            animation: pulse-logo 2s infinite ease-in-out;
        }
        @keyframes pulse-logo {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .gradient-bg { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); }
        .accent-bg { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        
        #error-toast {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100px);
            opacity: 0;
        }
        #error-toast.show { transform: translateY(0); opacity: 1; }

        .coupling-box {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #fbbf24;
            padding: 10px;
            border-radius: 8px;
        }

        .protection-box {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 10px;
            border-radius: 8px;
        }

        .ai-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .ai-box.alert-active {
            background: rgba(245, 158, 11, 0.15);
            border-color: #fbbf24;
        }
        
        .ai-box.danger-active {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        .sonabel-box {
            background: rgba(255, 255, 255, 0.07);
            border-left: 3px solid #10b981;
            padding: 10px;
            border-radius: 8px;
        }

        .sim-canvas-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media print {
            .no-print { display: none; }
            body { background: white; }
            .card-shadow { box-shadow: none; border: 1px solid #eee; }
            main { margin-top: 0 !important; }
            #splash-screen { display: none; }
        }
        
        .save-indicator {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .updating {
            animation: pulse-update 0.4s ease-in-out;
        }
        @keyframes pulse-update {
            0% { opacity: 1; }
            50% { opacity: 0.7; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="splash-screen">
        <div class="splash-logo">solaire.biz</div>
    </div>

    <div id="error-toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-50 px-6 py-4 bg-slate-900 text-white rounded-2xl shadow-2xl flex items-center space-x-3 pointer-events-none max-w-[90vw]">
        <div class="p-2 rounded-lg bg-red-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>
        <div class="flex flex-col">
            <span class="text-[10px] uppercase font-bold text-amber-400 tracking-widest">Alerte Syst√®me</span>
            <span id="error-message" class="text-xs font-medium">Message d'erreur</span>
        </div>
    </div>

    <header class="accent-bg text-white pt-8 pb-16 px-4 rounded-b-[3rem] shadow-xl">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-extrabold flex items-center justify-center md:justify-start">
                    <span class="mr-3">üáßüá´</span> Solaire Pro BF <span class="ml-2 text-sm bg-white/20 px-2 py-1 rounded text-xs uppercase tracking-widest">V4.7 Expert AI</span>
                </h1>
                <div class="flex items-center gap-3 mt-1">
                    <p class="text-amber-100 text-sm">Ing√©nierie Solaire & Protections √âlectriques</p>
                    <div id="save-status" class="save-indicator no-print">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                        <span id="save-text">Connect√©</span>
                    </div>
                </div>
            </div>
            <div class="no-print">
                <button onclick="window.print()" class="bg-white/10 hover:bg-white/20 p-3 rounded-2xl backdrop-blur-md flex items-center space-x-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    <span class="text-xs font-bold uppercase tracking-wider">Imprimer Devis</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 -mt-10">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center">
                            <span class="w-2 h-6 bg-amber-500 rounded mr-3"></span>
                            Bilan de Consommation
                        </h3>
                        <button onclick="addRow()" class="bg-amber-100 text-amber-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-amber-200 transition no-print">+ Ajouter</button>
                    </div>
                    <div id="appliance-container" class="space-y-3"></div>
                    <div class="mt-8 grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Puissance de Cr√™te</p>
                            <span id="peak-sum" class="text-xl font-bold text-slate-800">0 W</span>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Consommation Totale</p>
                            <span id="energy-sum" class="text-xl font-bold text-slate-800">0 Wh/j</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-slate-100">
                    <h3 class="font-bold text-slate-800 text-lg mb-6 flex items-center">
                        <span class="w-2 h-6 bg-blue-500 rounded mr-3"></span>
                        Configuration Technique
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Type de Projet</label>
                            <select id="project-type" onchange="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                                <option value="residentiel" selected>R√©sidentiel (Maison)</option>
                                <option value="tertiaire">Tertiaire (Bureau/Commerce)</option>
                                <option value="industriel">Industriel / Site Isol√©</option>
                                <option value="pompage">Pompage Solaire</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Localit√© (HSP)</label>
                            <select id="location" onchange="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                                <option value="5.6" selected>Ouagadougou (5.6)</option>
                                <option value="5.4">Bobo-Dioulasso (5.4)</option>
                                <option value="5.8">Dori (5.8)</option>
                                <option value="5.5">Koudougou (5.5)</option>
                                <option value="5.7">Fada N'Gourma (5.7)</option>
                                <option value="5.3">Banfora (5.3)</option>
                                <option value="5.6">Ouahigouya (5.6)</option>
                                <option value="5.5">Kaya (5.5)</option>
                                <option value="5.4">Tenkodogo (5.4)</option>
                                <option value="5.4">D√©dougou (5.4)</option>
                                <option value="5.3">Gaoua (5.3)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider text-red-600">Temp. Ambiante Max (¬∞C)</label>
                            <input type="number" id="temp-max" value="40" min="10" max="60" oninput="calculate(true)" class="w-full bg-red-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-red-500">
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Type de Syst√®me</label>
                            <select id="sys-type" onchange="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                                <option value="mppt" selected>MPPT Autonome</option>
                                <option value="hybrid-mono">Hybride Monophas√©</option>
                                <option value="hybrid-tri">Hybride Triphas√©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Puis. Panneau (Wc)</label>
                            <input type="number" id="panel-model" value="330" step="10" oninput="updatePanelSpecs(); calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Mod√®le de Panneaux</label>
                            <select id="panel-type" onchange="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                                <option value="0.75" selected>Monocristallin (Premium)</option>
                                <option value="0.68">Polycristallin (Standard)</option>
                                <option value="0.62">Amorphe (Souple)</option>
                            </select>
                        </div>

                        <!-- AJOUT DES CHAMPS VMP ET VOC VISIBLES -->
                        <div class="bg-amber-50/50 p-2 rounded-xl border border-amber-100">
                            <label class="block text-[10px] font-bold text-amber-600 uppercase mb-2 tracking-wider">Tension Vmp (V)</label>
                            <input type="number" id="panel-vmp" value="34.2" step="0.1" oninput="calculate(true)" class="w-full bg-white border-none rounded-lg p-2 text-sm font-bold text-amber-700 focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div class="bg-amber-50/50 p-2 rounded-xl border border-amber-100">
                            <label class="block text-[10px] font-bold text-amber-600 uppercase mb-2 tracking-wider">Tension Voc (V)</label>
                            <input type="number" id="panel-voc" value="41.5" step="0.1" oninput="calculate(true)" class="w-full bg-white border-none rounded-lg p-2 text-sm font-bold text-amber-700 focus:ring-2 focus:ring-amber-500">
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-indigo-500 uppercase mb-2 tracking-wider">Tension Syst√®me (V) <span class="bg-indigo-100 px-1 rounded">AUTO</span></label>
                            <input type="number" id="sys-voltage" value="24" readonly class="w-full bg-indigo-50 border-none rounded-xl p-3 text-sm font-bold text-indigo-700 cursor-not-allowed">
                            <p class="text-[8px] text-indigo-400 mt-1 italic">D√©fini par la puissance onduleur.</p>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Type de Batterie</label>
                            <select id="batt-type" onchange="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                                <option value="gel" selected>GEL (Sans entretien)</option>
                                <option value="lithium">Lithium (LiFePO4)</option>
                                <option value="agm">AGM</option>
                                <option value="opzv">OPzV (Tubulaire)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Capacit√© Batterie (Ah)</label>
                            <input type="number" id="batt-unit-ah" value="200" step="10" oninput="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Autonomie (Jours)</label>
                            <input type="number" id="autonomy" value="1.5" step="0.5" oninput="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Distance C√¢blage (m)</label>
                            <input type="number" id="cable-length" value="15" min="1" step="1" oninput="calculate(true)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-semibold focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex items-center space-x-2 mb-4">
                            <svg class="text-amber-500" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="12" y1="5" x2="12" y2="19"/></svg>
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tarifs (FCFA)</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Panneau (/Wc)</label>
                                <input type="number" id="price-panel-wc" value="300" oninput="calculate(true)" class="w-full bg-amber-50 border border-amber-100 rounded-lg p-2 text-xs font-bold text-amber-700 outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Batterie (/Ah)</label>
                                <input type="number" id="price-batt-ah" value="950" oninput="calculate(true)" class="w-full bg-amber-50 border border-amber-100 rounded-lg p-2 text-xs font-bold text-amber-700 outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Onduleur (/VA)</label>
                                <input type="number" id="price-inv-va" value="150" oninput="calculate(true)" class="w-full bg-amber-50 border border-amber-100 rounded-lg p-2 text-xs font-bold text-amber-700 outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Main d'≈ìuvre</label>
                                <input type="number" id="price-labor" value="50000" oninput="calculate(true)" class="w-full bg-amber-50 border border-amber-100 rounded-lg p-2 text-xs font-bold text-amber-700 outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div id="result-card" class="gradient-bg text-white p-8 rounded-[2.5rem] card-shadow sticky top-8 transition-all duration-500 border-4 border-transparent">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex flex-col">
                            <h3 class="text-amber-400 font-bold uppercase tracking-widest text-[10px]">Synth√®se Technique</h3>
                            <span id="res-project-type" class="text-[9px] text-white/50 font-medium italic">Mise √† jour Auto Active</span>
                        </div>
                        <div id="status-badge" class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-[9px] font-bold uppercase">En direct</div>
                    </div>
                    
                    <div id="scroll-results" class="space-y-6 overflow-y-auto max-h-[75vh] pr-2">
                        <div>
                            <p class="text-white/60 text-[10px] uppercase font-bold mb-1 tracking-wider">G√©n√©rateur PV (R√©el Chaleur)</p>
                            <p class="text-3xl font-bold mb-3"><span id="res-total-wc">0</span> <span class="text-amber-400 text-sm">Wc</span></p>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div class="bg-white/5 border border-white/10 rounded-xl p-2 text-center">
                                    <p class="text-[8px] text-white/40 uppercase font-bold mb-1">Inclinaison</p>
                                    <p class="text-xs font-bold text-amber-400"><span id="res-tilt">15</span>¬∞</p>
                                </div>
                                <div class="bg-white/5 border border-white/10 rounded-xl p-2 text-center">
                                    <p class="text-[8px] text-white/40 uppercase font-bold mb-1">Perte Chaleur</p>
                                    <p class="text-xs font-bold text-red-400"><span id="res-heat-loss">0</span>%</p>
                                </div>
                            </div>

                            <div class="sim-canvas-container mb-3 relative group">
                                <div class="absolute top-2 left-2 flex items-center gap-1 z-10">
                                    <div class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></div>
                                    <span class="text-[8px] font-bold uppercase text-white/40 tracking-tighter">Croquis Technique 2D</span>
                                </div>
                                <canvas id="solar-sim" class="w-full h-[180px] cursor-crosshair"></canvas>
                            </div>
                            <div id="panel-coupling" class="coupling-box text-[11px]">
                                <p class="font-bold text-amber-400 mb-1 underline">Couplage Panneaux :</p>
                                <span id="panel-coupling-text">--</span>
                            </div>
                        </div>

                        <div>
                            <p class="text-red-400 text-[10px] uppercase font-bold mb-1 tracking-widest">Protections √âlectriques</p>
                            <div class="protection-box mt-2 text-[11px] space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-white/60">Disj. Batterie :</span>
                                    <span id="res-prot-batt" class="font-bold text-white">--</span>
                                </div>
                                <div class="flex justify-between border-t border-white/10 pt-1">
                                    <span class="text-white/60">Protection PV :</span>
                                    <span id="res-prot-pv" class="font-bold text-white">--</span>
                                </div>
                                <div class="flex justify-between border-t border-white/10 pt-1">
                                    <span class="text-white/60">Parafoudre :</span>
                                    <span class="font-bold text-amber-400">Recommand√©</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-white/60 text-[10px] uppercase font-bold mb-1 tracking-wider">R√©gul.</p>
                                <p class="text-xl font-bold"><span id="res-regulator">0</span> <span class="text-amber-400 text-xs">A</span></p>
                            </div>
                            <div>
                                <p class="text-white/60 text-[10px] uppercase font-bold mb-1 tracking-wider">Ondul.</p>
                                <p class="text-xl font-bold"><span id="res-inverter">0</span> <span class="text-amber-400 text-xs">VA</span></p>
                            </div>
                        </div>

                        <div>
                            <p class="text-white/60 text-[10px] uppercase font-bold mb-1 tracking-wider">Section de C√¢ble (AC Sortie)</p>
                            <p class="text-3xl font-bold"><span id="res-cable-section">--</span> <span class="text-amber-400 text-sm">mm¬≤</span></p>
                            <p id="cable-note" class="text-[9px] text-white/40 mt-1 italic">D√©fini par la Puissance de l'Onduleur.</p>
                        </div>

                        <div>
                            <p class="text-white/60 text-[10px] uppercase font-bold mb-1 tracking-wider">Stockage d'√ânergie</p>
                            <p class="text-3xl font-bold"><span id="res-batteries">0</span> <span class="text-amber-400 text-sm">Ah</span></p>
                            <div id="battery-coupling" class="coupling-box mt-3 text-[11px]">
                                <span id="battery-coupling-text">--</span>
                            </div>
                        </div>

                        <div id="ai-container" class="ai-box text-[10px] text-cyan-50/80 leading-relaxed">
                            <div class="flex items-center gap-2 mb-1">
                                <div id="ai-pulse" class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></div>
                                <p id="ai-title" class="text-cyan-400 font-bold uppercase tracking-widest">IA Sentinel Expert</p>
                            </div>
                            <span id="ai-feedback">Analyse du syst√®me en cours...</span>
                        </div>

                        <div class="sonabel-box text-[10px] leading-relaxed">
                            <p class="text-emerald-400 font-bold mb-1">Comparatif SONABEL :</p>
                            <div class="flex justify-between"><span class="text-white/60">√âconomie /mois :</span><span id="res-money-saved" class="font-bold text-emerald-400">0 FCFA</span></div>
                        </div>

                        <div class="pt-4 border-t border-white/10">
                            <p class="text-amber-400 text-[10px] uppercase font-bold mb-1 tracking-widest">Estimation Mat√©riel</p>
                            <p class="text-2xl font-bold text-white"><span id="res-total-price">0</span> <span class="text-[10px] opacity-60 ml-1">FCFA</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) splash.classList.add('hidden');
            }, 2500);
            updatePanelSpecs(); 
        });

        const PANEL_DB = {
            100: { vmp: 18.2, voc: 22.1 },
            150: { vmp: 18.5, voc: 22.5 },
            200: { vmp: 20.1, voc: 24.2 },
            250: { vmp: 30.5, voc: 37.5 },
            300: { vmp: 32.4, voc: 39.5 },
            330: { vmp: 34.2, voc: 41.5 },
            370: { vmp: 39.5, voc: 47.6 },
            400: { vmp: 41.2, voc: 49.5 },
            450: { vmp: 41.5, voc: 49.8 },
            500: { vmp: 42.8, voc: 51.5 },
            550: { vmp: 43.1, voc: 51.9 }
        };

        window.updatePanelSpecs = function() {
            const power = parseInt(document.getElementById('panel-model').value);
            const vmpInput = document.getElementById('panel-vmp');
            const vocInput = document.getElementById('panel-voc');

            if (PANEL_DB[power]) {
                vmpInput.value = PANEL_DB[power].vmp;
                vocInput.value = PANEL_DB[power].voc;
            } else {
                vmpInput.value = (power * 0.1).toFixed(1);
                vocInput.value = (power * 0.12).toFixed(1);
            }
        };

        // --- TEST LOCAL SANS FIREBASE ---
window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.classList.add('hidden');
    }, 1000);

    // Ajout appareils par d√©faut
    addRow({n: "√âclairage LED", q: 6, w: 10, h: 6});
    addRow({n: "Frigo A+", q: 1, w: 120, h: 24});

    updatePanelSpecs();
    calculate(false); // forcer calcul
});
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'solaire-pro-bf-v4';

        let currentUser = null;
        let saveTimeout = null;
        let calcTimeout = null;

        function drawSolarSimulation(nbPanels, inSeries) {
            const canvas = document.getElementById('solar-sim');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, w, h);
            if (nbPanels <= 0) return;

            const strings = Math.ceil(nbPanels / inSeries);
            const panelW = 22;
            const panelH = 35;
            const gap = 8;
            const startX = (w - (strings * (panelW + gap))) / 2;
            const startY = (h - (inSeries * (panelH + gap))) / 2;

            let count = 0;
            for (let i = 0; i < strings; i++) {
                for (let j = 0; j < inSeries; j++) {
                    if (count >= nbPanels) break;
                    const x = startX + i * (panelW + gap);
                    const y = startY + j * (panelH + gap);
                    ctx.fillStyle = '#1e293b';
                    ctx.beginPath();
                    ctx.roundRect(x, y, panelW, panelH, 2);
                    ctx.fill();
                    ctx.strokeStyle = '#334155';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    count++;
                }
            }
        }

        async function saveData() {
            if (!currentUser) return;
            const appliances = Array.from(document.querySelectorAll('#appliance-container > div')).map(row => ({
                n: row.querySelector('.app-name').value,
                q: parseFloat(row.querySelector('.app-qty').value) || 0,
                w: parseFloat(row.querySelector('.app-power').value) || 0,
                h: parseFloat(row.querySelector('.app-hours').value) || 0
            }));
            const config = {
                projectType: document.getElementById('project-type').value,
                location: document.getElementById('location').value,
                tempMax: document.getElementById('temp-max').value,
                sysType: document.getElementById('sys-type').value,
                panelModel: document.getElementById('panel-model').value,
                panelType: document.getElementById('panel-type').value,
                panelVmp: document.getElementById('panel-vmp').value,
                panelVoc: document.getElementById('panel-voc').value,
                sysVoltage: document.getElementById('sys-voltage').value,
                battType: document.getElementById('batt-type').value,
                battUnitAh: document.getElementById('batt-unit-ah').value,
                autonomy: document.getElementById('autonomy').value,
                cableLength: document.getElementById('cable-length').value,
                tarifs: {
                    panel: document.getElementById('price-panel-wc').value,
                    batt: document.getElementById('price-batt-ah').value,
                    inv: document.getElementById('price-inv-va').value,
                    labor: document.getElementById('price-labor').value
                }
            };
            try {
                const userDoc = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'current');
                await setDoc(userDoc, { appliances, config, updatedAt: Date.now() });
                document.getElementById('save-text').innerText = "Sauvegard√©";
            } catch (e) { document.getElementById('save-text').innerText = "Cloud Erreur"; }
        }

        async function loadData(user) {
            const userDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'current');
            const snap = await getDoc(userDoc);
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('appliance-container').innerHTML = '';
                data.appliances.forEach(app => addRow(app));
                const c = data.config;
                if(c) {
                    document.getElementById('project-type').value = c.projectType || 'residentiel';
                    document.getElementById('location').value = c.location || '5.6';
                    document.getElementById('temp-max').value = c.tempMax || 40;
                    document.getElementById('sys-type').value = c.sysType || 'mppt';
                    document.getElementById('panel-model').value = c.panelModel || 330;
                    document.getElementById('panel-type').value = c.panelType || '0.75';
                    if(c.panelVmp) document.getElementById('panel-vmp').value = c.panelVmp;
                    if(c.panelVoc) document.getElementById('panel-voc').value = c.panelVoc;
                    document.getElementById('sys-voltage').value = c.sysVoltage || 24;
                    document.getElementById('batt-type').value = c.battType || 'gel';
                    document.getElementById('batt-unit-ah').value = c.battUnitAh || 200;
                    document.getElementById('autonomy').value = c.autonomy || 1.5;
                    document.getElementById('cable-length').value = c.cableLength || 15;
                    if(c.tarifs) {
                        document.getElementById('price-panel-wc').value = c.tarifs.panel;
                        document.getElementById('price-batt-ah').value = c.tarifs.batt;
                        document.getElementById('price-inv-va').value = c.tarifs.inv;
                        document.getElementById('price-labor').value = c.tarifs.labor;
                    }
                }
            } else {
                addRow({n: "√âclairage LED", q: 6, w: 10, h: 6});
                addRow({n: "Frigo A+", q: 1, w: 120, h: 24});
            }
            updatePanelSpecs(); 
            window.calculate(false);
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) loadData(user);
        });

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        };
        initAuth();

        window.calculate = function(triggerSave = true) {
            clearTimeout(calcTimeout);
            calcTimeout = setTimeout(() => {
                performCalculation(triggerSave);
            }, 50); 
        };

        function performCalculation(triggerSave) {
            const resultCard = document.getElementById('result-card');
            if (resultCard) {
                resultCard.classList.add('updating');
                setTimeout(() => resultCard.classList.remove('updating'), 400);
            }

            const qties = document.querySelectorAll('.app-qty'), powers = document.querySelectorAll('.app-power'), hours = document.querySelectorAll('.app-hours');
            let dailyEnergy = 0, peakSum = 0;
            qties.forEach((_, i) => {
                const q = parseFloat(qties[i].value) || 0, p = parseFloat(powers[i].value) || 0, h = parseFloat(hours[i].value) || 0;
                dailyEnergy += (q * p * h); peakSum += (q * p);
            });

            document.getElementById('peak-sum').innerText = peakSum.toLocaleString() + " W";
            document.getElementById('energy-sum').innerText = dailyEnergy.toLocaleString() + " Wh/j";

            let invVA = Math.ceil(peakSum * 1.3);
            const standardInverters = [500, 1000, 2000, 3000, 5000, 8000, 10000];
            const finalInvVA = standardInverters.find(p => p >= invVA) || invVA;
            document.getElementById('res-inverter').innerText = finalInvVA.toLocaleString();

            let autoVoltage = 12;
            if (finalInvVA > 3000) autoVoltage = 48;
            else if (finalInvVA > 1000) autoVoltage = 24;
            document.getElementById('sys-voltage').value = autoVoltage;
            const sysV = autoVoltage;

            const hsp = parseFloat(document.getElementById('location').value);
            const pUnit = parseFloat(document.getElementById('panel-model').value) || 330;
            const pEff = parseFloat(document.getElementById('panel-type').value);
            const battUnitAh = parseFloat(document.getElementById('batt-unit-ah').value) || 200;
            const autonomy = parseFloat(document.getElementById('autonomy').value) || 1;
            const cableLen = parseFloat(document.getElementById('cable-length').value) || 15;
            const sysType = document.getElementById('sys-type').value;
            const tempMax = parseFloat(document.getElementById('temp-max').value) || 40;

            const tempCoeff = -0.0038, Tcell = tempMax + 25; 
            const heatLossFactor = 1 - Math.abs((Tcell - 25) * tempCoeff);
            const pRealHeat = pUnit * heatLossFactor;
            document.getElementById('res-heat-loss').innerText = ((1 - heatLossFactor) * 100).toFixed(1);
            document.getElementById('res-tilt').innerText = 15;

            if (dailyEnergy > 0) {
                const totalWcNeeded = Math.ceil(dailyEnergy / (hsp * pEff));
                
                // --- LOGIQUE DE COUPLAGE BAS√âE SUR TENSIONS D√âSORMAIS VISIBLES ---
                const pVmp = parseFloat(document.getElementById('panel-vmp').value);
                
                // Nombre de panneaux en s√©rie pour atteindre la tension syst√®me
let panelsInSeries = Math.ceil(sysV / (pVmp * 0.9)); // marge s√©curit√© 10%
panelsInSeries = Math.max(1, panelsInSeries);

// Nombre total de panneaux n√©cessaire
let nbPanels = Math.ceil(totalWcNeeded / pRealHeat);

// Nombre de strings en parall√®le
let stringsInParallel = Math.ceil(nbPanels / panelsInSeries);

// Ajustement total pour que ce soit multiple exact
nbPanels = panelsInSeries * stringsInParallel;

const totalWcFinal = nbPanels * pUnit;

                
                document.getElementById('res-total-wc').innerText = totalWcFinal.toLocaleString();
                document.getElementById('panel-coupling-text').innerText = `${nbPanels} panneaux (${panelsInSeries}S / ${nbPanels/panelsInSeries}P)`;
                drawSolarSimulation(nbPanels, panelsInSeries);
                
                let regAmperage = Math.ceil((totalWcFinal / sysV) * 1.25);
                document.getElementById('res-regulator').innerText = regAmperage;

                const I_batt_max = finalInvVA / sysV;
                const prot_batt = [40, 63, 80, 100, 125, 160, 200, 250].find(c => c >= I_batt_max * 1.25) || Math.ceil(I_batt_max * 1.25);
                document.getElementById('res-prot-batt').innerText = prot_batt + " A";
                
                const I_pv_max = (totalWcFinal / sysV);
                const prot_pv = [16, 25, 32, 40, 50, 63].find(c => c >= I_pv_max * 1.25) || Math.ceil(I_pv_max * 1.25);
                document.getElementById('res-prot-pv').innerText = prot_pv + " A";

                const rho = 0.0175; 
                const cosPhi = 0.8;
                let sCalc = 0;

                if (sysType === 'hybrid-tri') {
                    const iAC = finalInvVA / (400 * 1.732 * cosPhi);
                    sCalc = (1.732 * rho * cableLen * iAC) / (400 * 0.03);
                } else {
                    const iAC = finalInvVA / 230;
                    sCalc = (2 * rho * cableLen * iAC) / (230 * 0.03);
                }

                const standardSections = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120];
                const finalSection = standardSections.find(s => s >= sCalc) || 120;
                document.getElementById('res-cable-section').innerText = finalSection;

                const dod = document.getElementById('batt-type').value === 'lithium' ? 0.8 : 0.5;
                const battAhNeeded = Math.ceil((dailyEnergy * autonomy) / (sysV * dod));
                const bS = Math.ceil(sysV / 12); // nombre en s√©rie pour atteindre la tension
const bP = Math.ceil(battAhNeeded / battUnitAh); // nombre en parall√®le pour atteindre Ah

const totalBatt = bS * bP;

document.getElementById('res-batteries').innerText = (bP * battUnitAh).toLocaleString();
document.getElementById('battery-coupling-text').innerText = `${totalBatt} batteries (${bS}S / ${bP}P)`;

                const tP = parseFloat(document.getElementById('price-panel-wc').value) || 0;
                const tB = parseFloat(document.getElementById('price-batt-ah').value) || 0;
                const tI = parseFloat(document.getElementById('price-inv-va').value) || 0;
                const tL = parseFloat(document.getElementById('price-labor').value) || 0;
                const budget = (totalWcFinal * tP) + (bP * bS * battUnitAh * (tB/battUnitAh)) + (finalInvVA * tI) + tL;
                document.getElementById('res-total-price').innerText = Math.round(budget).toLocaleString();

                const saved = (dailyEnergy / 1000) * 30 * 125;
                document.getElementById('res-money-saved').innerText = Math.round(saved).toLocaleString() + " FCFA";

                const aiBox = document.getElementById('ai-container');
                const aiFeedback = document.getElementById('ai-feedback');

                if (sysType === 'hybrid-tri' && finalInvVA < 5000) {
                    aiFeedback.innerText = "Info : Un syst√®me triphas√© est recommand√© √† partir de 5kVA.";
                    aiBox.className = "ai-box alert-active text-[10px] text-amber-50 leading-relaxed";
                } else if (finalSection >= 35) {
                    aiFeedback.innerText = "Attention : Section de c√¢ble importante (" + finalSection + "mm¬≤). V√©rifiez la capacit√© des borniers onduleur.";
                    aiBox.className = "ai-box alert-active text-[10px] text-amber-50 leading-relaxed";
                } else {
                    aiFeedback.innerText = `Analyse OK : Couplage valid√© pour panneaux ${pUnit}W (Vmp:${pVmp}V).`;
                    aiBox.className = "ai-box text-[10px] text-cyan-50/80 leading-relaxed";
                }
            }

            if (triggerSave && currentUser) {
                document.getElementById('save-text').innerText = "En cours...";
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveData, 2000);
            }
        }

        window.addRow = function(data = {n: "Appareil", q: 1, w: 10, h: 4}) {
            const container = document.getElementById('appliance-container');
            const rowId = 'row-' + Math.random().toString(36).substr(2, 9);
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center bg-slate-50 p-3 rounded-xl border border-slate-100 group transition-all hover:bg-slate-100";
            div.id = rowId;
            div.innerHTML = `
                <input type="text" value="${data.n}" oninput="calculate()" class="app-name flex-1 bg-transparent text-sm font-semibold outline-none" placeholder="Nom">
                <div class="flex items-center space-x-1">
                    <input type="number" value="${data.q}" oninput="calculate()" class="app-qty w-10 bg-white rounded p-1 text-xs text-center font-bold border border-transparent focus:border-amber-300">
                    <input type="number" value="${data.w}" oninput="calculate()" class="app-power w-14 bg-white rounded p-1 text-xs text-center font-bold border border-transparent focus:border-amber-300">
                    <input type="number" value="${data.h}" oninput="calculate()" class="app-hours w-10 bg-white rounded p-1 text-xs text-center font-bold border border-transparent focus:border-amber-300">
                </div>
                <button onclick="document.getElementById('${rowId}').remove(); calculate();" class="text-slate-300 hover:text-red-500 transition-colors px-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            `;
            container.appendChild(div);
            calculate(true);
        };
    </script>
</body>
</html>

